#!/usr/bin/env bash
_VXTIME_OUT=25
echo "[fetch_vxvault_pe32 - $$] starting using url_timeouts=$_VXTIME_OUT."
command -v wget >/dev/null 2>&1 || { echo >&2 "I require 'wget' but it's not installed.  Aborting."; exit 1; }
command -v parallel >/dev/null 2>&1 || { echo >&2 "I require 'parallel' but it's not installed.  Aborting."; exit 1; }
command -v tail >/dev/null 2>&1 || { echo >&2 "I require 'tail' but it's not installed.  Aborting."; exit 1; }
command -v xargs >/dev/null 2>&1 || { echo >&2 "I require 'xargs' but it's not installed.  Aborting."; exit 1; }
command -v fdupes >/dev/null 2>&1 || { echo >&2 "I require 'fdupes' but it's not installed.  Aborting."; exit 1; }
mkdir -p ./malware_lists
mkdir -p ./malware

rm -f ./malware_lists/URL_List.php

# set progress option accordingly for wget 1.6 and above
wget --help | grep -q '\--show-progress' && \
  _PROGRESS_OPT="-q --show-progress --progress=bar:force" || _PROGRESS_OPT=""

wget $_PROGRESS_OPT --timeout=$_VXTIME_OUT --directory-prefix=./malware_lists http://vxvault.net//URL_List.php
if [ ! -e "./malware_lists/URL_List.php" ]
then 
  "Failed to create or reach vxvault.  Aborting."; exit 1;
fi
tail -n +4 ./malware_lists/URL_List.php > ./malware_lists/URL_List_$$.txt
rm -f ./malware_lists/URL_List.php
echo "[fetch_vxvault_pe32 - $$] fetching malware.."
cat ./malware_lists/URL_List_$$.txt | parallel --no-run-if-empty --no-notice --trim r --gnu "wget $_PROGRESS_OPT --directory-prefix=./malware -nc --timeout=$_VXTIME_OUT {}"

echo "[fetch_vxvault_pe32 - $$] deduplication.."
fdupes -N -d -r ./malware

# Remove non PE32 files
echo "[fetch_vxvault_pe32 - $$] keeping PE32 files only.. "
find ./malware -type f ! -name "*.*" -print0 |xargs -I {} -0 mv {} ./{}.exe
find ./malware -type f -print0 | xargs -0 file -- |grep -v PE32 |grep -o '^\.\/[^:]*' |xargs -I {} rm -f {}

# Print list
find ./malware -print0 | xargs -0 file --
echo "[fetch_vxvault_pe32 - $$] done."
