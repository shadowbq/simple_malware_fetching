#!/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/bin:/opt/sbin
export DISPLAY=:0.0

_MALWARE="./"

command -v tail >/dev/null 2>&1 || { echo >&2 "I require 'tail' but it's not installed.  Aborting."; exit 1; }
command -v xargs >/dev/null 2>&1 || { echo >&2 "I require 'xargs' but it's not installed.  Aborting."; exit 1; }
command -v fdupes >/dev/null 2>&1 || { echo >&2 "I require 'fdupes' but it's not installed.  Aborting."; exit 1; }

echo "[filter_pe32 - $$] deduplication.."
fdupes -N -d -r "$_MALWARE"

# Remove non PE32 files
echo "[filter_pe32 - $$] keeping PE32 files only.. "
find "$_MALWARE" -type f ! -name "*.*" -print0 |xargs -I {} -0 mv {} "$_MALWARE/"{}.exe
find "$_MALWARE" -type f -print0 | xargs -0 file -- |grep -v PE32 |grep -o '^\.\/[^:]*' |xargs -I {} rm -f {}

# Print list
find "$_MALWARE" -print0 | xargs -0 file --

echo "[filter_pe32 - $$] done. "
